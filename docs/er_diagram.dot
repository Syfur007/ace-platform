// ER diagram for ace-platform (core tables and relationships)
digraph ER {
  rankdir=LR;
  node [shape=record, fontname="Helvetica"];

  users [label="{users|id PK\lemail\lpassword_hash\lrole\lcreated_at\lupdated_at\ldeleted_at\l}"];

  auth_sessions [label="{auth_sessions|id PK\nuser_id FK -> users.id\nrole\naudience\nip\nuser_agent\ncreated_at\nlast_seen_at\nexpires_at\nrevoked_at\nrevoked_reason\l}"];
  auth_refresh_tokens [label="{auth_refresh_tokens|id PK\nsession_id FK -> auth_sessions.id\ntoken_hash\ncreated_at\nexpires_at\nrevoked_at\nreplaced_by_token_id\l}"];

  auth_session_groups [label="{auth_session_groups|id PK\nname\ncreated_at\l}"];
  auth_session_group_memberships [label="{auth_session_group_memberships|group_id FK -> auth_session_groups.id\nuser_id FK -> users.id\ncreated_at\nPK(group_id,user_id)\l}"];
  auth_session_limits_group [label="{auth_session_limits_group|group_id PK -> auth_session_groups.id\nmax_active_sessions\l}"];
  auth_session_limits_user [label="{auth_session_limits_user|user_id PK -> users.id\nmax_active_sessions\l}"];
  auth_session_limits_role [label="{auth_session_limits_role|role PK\nmax_active_sessions\l}"];

  exam_packages [label="{exam_packages|id UUID PK\ncode\nname\nsubtitle\noverview\nmodules jsonb\nhighlights jsonb\nmodule_sections jsonb\nis_hidden\ncreated_at\nupdated_at\l}"];
  user_exam_package_enrollments [label="{user_exam_package_enrollments|user_id FK -> users.id\nexam_package_id FK -> exam_packages.id\ncreated_at\nPK(user_id,exam_package_id)\l}"];

  practice_test_templates [label="{practice_test_templates|id UUID PK\nexam_package_id FK -> exam_packages.id\nname\nsection\ntopic_id\ndifficulty_id\nis_timed\ntarget_count\nis_published\ncreated_by_user_id\nupdated_by_user_id\l}"];
  practice_sessions [label="{practice_sessions|id PK\nuser_id FK -> users.id\npackage_id FK -> exam_packages.id\ntemplate_id FK -> practice_test_templates.id\nis_timed\nstarted_at\ncurrent_index\nquestion_order jsonb\nquestions_snapshot jsonb\ncorrect_count\nstatus\nlast_activity_at\l}"];
  practice_answers [label="{practice_answers|id PK\nsession_id FK -> practice_sessions.id\nuser_id FK -> users.id\nquestion_id\nchoice_id\ncorrect\nexplanation\nts\l}"];

  exam_sessions [label="{exam_sessions|user_id FK -> users.id\nid PK (composite user_id,id)\nstatus\nexam_package_id FK -> exam_packages.id\nsnapshot jsonb\ncreated_at\nupdated_at\nlast_heartbeat_at\nsubmitted_at\nterminated_at\l}"];
  exam_session_events [label="{exam_session_events|id PK\nuser_id\nsession_id\nevent_type\npayload jsonb\ncreated_at\nFK(user_id,session_id) -> exam_sessions(user_id,id)\l}"];
  exam_session_flags [label="{exam_session_flags|id PK\nuser_id\nsession_id\nflag_type\nnote\ncreated_by_user_id FK -> users.id\ncreated_at\nFK(user_id,session_id) -> exam_sessions(user_id,id)\l}"];

  audit_log [label="{audit_log|id PK\nactor_user_id FK -> users.id\nactor_role\naction\ntarget_type\ntarget_id\nmetadata jsonb\ncreated_at\l}"];

  question_banks [label="{question_banks|id PK\nname\nexam_package_id (legacy)\ncreated_by_user_id FK -> users.id\nis_hidden\ncreated_at\l}"];
  exam_package_question_bank_packages [label="{exam_package_question_bank_packages|exam_package_id FK -> exam_packages.id\nquestion_bank_package_id FK -> question_banks.id\nPK(exam_package_id,question_bank_package_id)\l}"];
  question_bank_topics [label="{question_bank_topics|id PK\npackage_id FK -> question_banks.id\nname\ncreated_by_user_id\nis_hidden\ncreated_at\l}"];
  question_bank_difficulties [label="{question_bank_difficulties|id PK\ndisplay_name\nsort_order\l}"];
  question_bank_questions [label="{question_bank_questions|id PK\npackage_id FK -> question_banks.id\ntopic_id FK -> question_bank_topics.id\ndifficulty_id FK -> question_bank_difficulties.id\nprompt\nexplanation_text\nstatus\ncreated_by_user_id\nupdated_by_user_id\ncreated_at\nupdated_at\l}"];
  question_bank_choices [label="{question_bank_choices|id PK\nquestion_id FK -> question_bank_questions.id\norder_index\ntext\l}"];
  question_bank_correct_choice [label="{question_bank_correct_choice|question_id PK -> question_bank_questions.id\nchoice_id FK -> question_bank_choices.id\l}"];

  // Relationships (edges)
  auth_sessions -> users [label="user_id"];
  auth_refresh_tokens -> auth_sessions [label="session_id"];

  auth_session_group_memberships -> auth_session_groups [label="group_id"];
  auth_session_group_memberships -> users [label="user_id"];
  auth_session_limits_group -> auth_session_groups [label="group_id"];

  user_exam_package_enrollments -> users [label="user_id"];
  user_exam_package_enrollments -> exam_packages [label="exam_package_id"];

  practice_sessions -> users [label="user_id"];
  practice_sessions -> exam_packages [label="package_id"];
  practice_sessions -> practice_test_templates [label="template_id"];
  practice_answers -> practice_sessions [label="session_id"];

  exam_sessions -> users [label="user_id"];
  exam_sessions -> exam_packages [label="exam_package_id"];
  exam_session_events -> exam_sessions [label="(user_id,session_id)"];
  exam_session_flags -> exam_sessions [label="(user_id,session_id)"];

  audit_log -> users [label="actor_user_id"];

  exam_package_question_bank_packages -> exam_packages [label="exam_package_id"];
  exam_package_question_bank_packages -> question_bank [label="question_bank_package_id"];
  question_bank_topics -> question_bank [label="package_id"];
  question_bank_questions -> question_bank [label="package_id"];
  question_bank_questions -> question_bank_topics [label="topic_id"];
  question_bank_questions -> question_bank_difficulties [label="difficulty_id"];
  question_bank_choices -> question_bank_questions [label="question_id"];
  question_bank_correct_choice -> question_bank_questions [label="question_id"];
  question_bank_correct_choice -> question_bank_choices [label="choice_id"];
}
