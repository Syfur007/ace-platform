openapi: 3.0.3
info:
  title: ACE API
  version: 0.1.0
servers:
  - url: http://localhost:8080
paths:
  /healthz:
    get:
      operationId: healthz
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthzResponse'

  /auth/register:
    post:
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '200':
          description: Registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /auth/login:
    post:
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /auth/me:
    get:
      operationId: me
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /practice-sessions:
    post:
      operationId: createPracticeSession
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePracticeSessionRequest'
      responses:
        '200':
          description: Practice session created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PracticeSessionResponse'

  /exam-sessions/{sessionId}/heartbeat:
    post:
      operationId: heartbeat
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HeartbeatRequest'
      responses:
        '200':
          description: Heartbeat accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HeartbeatResponse'

  /practice-sessions/{sessionId}:
    get:
      operationId: getPracticeSession
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Practice session state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PracticeSessionResponse'

  /practice-sessions/{sessionId}/answers:
    post:
      operationId: submitPracticeAnswer
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitPracticeAnswerRequest'
      responses:
        '200':
          description: Answer accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmitPracticeAnswerResponse'

  /practice-sessions/{sessionId}/summary:
    get:
      operationId: getPracticeSessionSummary
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Practice summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PracticeSessionSummaryResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    HealthzResponse:
      type: object
      required: [status, ts]
      properties:
        status:
          type: string
        ts:
          type: string
          description: RFC3339 timestamp

    HeartbeatRequest:
      type: object
      required: [sessionId, ts, snapshot]
      properties:
        sessionId:
          type: string
        ts:
          type: string
          description: RFC3339 timestamp
        snapshot:
          description: Latest client-side snapshot for recovery
          nullable: true

    HeartbeatResponse:
      type: object
      required: [ok, serverTs]
      properties:
        ok:
          type: boolean
        serverTs:
          type: string
          description: RFC3339 timestamp

    CreatePracticeSessionRequest:
      type: object
      required: [timed, count]
      properties:
        packageId:
          type: string
          nullable: true
        timed:
          type: boolean
        count:
          type: integer
          minimum: 1
          maximum: 50

    PracticeQuestionChoice:
      type: object
      required: [id, text]
      properties:
        id:
          type: string
        text:
          type: string

    PracticeQuestion:
      type: object
      required: [id, prompt, choices]
      properties:
        id:
          type: string
        prompt:
          type: string
        choices:
          type: array
          items:
            $ref: '#/components/schemas/PracticeQuestionChoice'

    PracticeSessionResponse:
      type: object
      required: [sessionId, status, createdAt, isTimed, targetCount, currentIndex, total, correctCount]
      properties:
        sessionId:
          type: string
        status:
          type: string
          enum: [active, finished]
        createdAt:
          type: string
          description: RFC3339 timestamp
        packageId:
          type: string
          nullable: true
        isTimed:
          type: boolean
        targetCount:
          type: integer
        currentIndex:
          type: integer
        total:
          type: integer
        correctCount:
          type: integer
        question:
          nullable: true
          $ref: '#/components/schemas/PracticeQuestion'

    SubmitPracticeAnswerRequest:
      type: object
      required: [questionId, choiceId]
      properties:
        questionId:
          type: string
        choiceId:
          type: string
        ts:
          type: string
          nullable: true
          description: RFC3339 timestamp

    SubmitPracticeAnswerResponse:
      type: object
      required: [correct, explanation, done]
      properties:
        correct:
          type: boolean
        explanation:
          type: string
        done:
          type: boolean

    PracticeSessionSummaryResponse:
      type: object
      required: [sessionId, total, correctCount, accuracy]
      properties:
        sessionId:
          type: string
        total:
          type: integer
        correctCount:
          type: integer
        accuracy:
          type: number
          format: float

    RegisterRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
        password:
          type: string
          description: Plaintext password (sent over HTTPS in production)

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
        password:
          type: string

    User:
      type: object
      required: [id, email, createdAt]
      properties:
        id:
          type: string
        email:
          type: string
        createdAt:
          type: string
          description: RFC3339 timestamp

    AuthResponse:
      type: object
      required: [accessToken, user]
      properties:
        accessToken:
          type: string
        user:
          $ref: '#/components/schemas/User'
