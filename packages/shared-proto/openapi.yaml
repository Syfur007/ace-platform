openapi: 3.0.3
info:
  title: ACE API
  version: 0.1.0
servers:
  - url: http://localhost:8080
paths:
  /healthz:
    get:
      operationId: healthz
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthzResponse'

  /auth/register:
    post:
      deprecated: true
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '200':
          description: Registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /auth/login:
    post:
      deprecated: true
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /auth/me:
    get:
      deprecated: true
      operationId: me
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /student/auth/register:
    post:
      operationId: studentRegister
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '200':
          description: Registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /student/auth/login:
    post:
      operationId: studentLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /student/auth/me:
    get:
      operationId: studentMe
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /instructor/auth/login:
    post:
      operationId: instructorLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /instructor/auth/me:
    get:
      operationId: instructorMe
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /admin/auth/login:
    post:
      operationId: adminLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /admin/auth/me:
    get:
      operationId: adminMe
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /practice-sessions:
    get:
      operationId: listPracticeSessions
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: offset
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
        - in: query
          name: status
          required: false
          schema:
            type: string
            enum: [active, paused, finished]
      responses:
        '200':
          description: Practice sessions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListPracticeSessionsResponse'
    post:
      operationId: createPracticeSession
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePracticeSessionRequest'
      responses:
        '200':
          description: Practice session created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PracticeSessionResponse'

  /exam-sessions:
    get:
      operationId: listExamSessions
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: offset
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
        - in: query
          name: status
          required: false
          schema:
            type: string
            enum: [active, finished]
      responses:
        '200':
          description: Exam sessions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListExamSessionsResponse'

  /exam-sessions/{sessionId}/heartbeat:
    post:
      operationId: heartbeat
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HeartbeatRequest'
      responses:
        '200':
          description: Heartbeat accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HeartbeatResponse'

  /exam-sessions/{sessionId}:
    get:
      operationId: getExamSession
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Exam session state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExamSessionResponse'

  /exam-sessions/{sessionId}/submit:
    post:
      operationId: submitExamSession
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Exam session submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExamSessionResponse'

  /practice-sessions/{sessionId}:
    get:
      operationId: getPracticeSession
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Practice session state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PracticeSessionResponse'

  /practice-sessions/{sessionId}/pause:
    post:
      operationId: pausePracticeSession
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Practice session paused
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PracticeSessionResponse'

  /practice-sessions/{sessionId}/resume:
    post:
      operationId: resumePracticeSession
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Practice session resumed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PracticeSessionResponse'

  /practice-sessions/{sessionId}/answers:
    post:
      operationId: submitPracticeAnswer
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitPracticeAnswerRequest'
      responses:
        '200':
          description: Answer accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmitPracticeAnswerResponse'

  /practice-sessions/{sessionId}/summary:
    get:
      operationId: getPracticeSessionSummary
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Practice summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PracticeSessionSummaryResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    HealthzResponse:
      type: object
      required: [status, ts]
      properties:
        status:
          type: string
        ts:
          type: string
          description: RFC3339 timestamp

    HeartbeatRequest:
      type: object
      required: [sessionId, ts, snapshot]
      properties:
        sessionId:
          type: string
        ts:
          type: string
          description: RFC3339 timestamp
        snapshot:
          description: Latest client-side snapshot for recovery
          type: object
          additionalProperties: true
          nullable: true

    HeartbeatResponse:
      type: object
      required: [ok, serverTs]
      properties:
        ok:
          type: boolean
        serverTs:
          type: string
          description: RFC3339 timestamp

    ExamSessionResponse:
      type: object
      required: [sessionId, status, createdAt, updatedAt, lastHeartbeatAt, snapshot]
      properties:
        sessionId:
          type: string
        status:
          type: string
          enum: [active, finished]
        submittedAt:
          type: string
          nullable: true
          description: RFC3339 timestamp
        createdAt:
          type: string
          description: RFC3339 timestamp
        updatedAt:
          type: string
          description: RFC3339 timestamp
        lastHeartbeatAt:
          type: string
          description: RFC3339 timestamp
        snapshot:
          type: object
          additionalProperties: true

    ListExamSessionsResponse:
      type: object
      required: [items, limit, offset, hasMore]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ExamSessionListItem'
        limit:
          type: integer
        offset:
          type: integer
        hasMore:
          type: boolean

    ExamSessionListItem:
      type: object
      required: [sessionId, status, createdAt, updatedAt, lastHeartbeatAt]
      properties:
        sessionId:
          type: string
        status:
          type: string
          enum: [active, finished]
        submittedAt:
          type: string
          nullable: true
          description: RFC3339 timestamp
        createdAt:
          type: string
          description: RFC3339 timestamp
        updatedAt:
          type: string
          description: RFC3339 timestamp
        lastHeartbeatAt:
          type: string
          description: RFC3339 timestamp

    ListPracticeSessionsResponse:
      type: object
      required: [items, limit, offset, hasMore]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/PracticeSessionListItem'
        limit:
          type: integer
        offset:
          type: integer
        hasMore:
          type: boolean

    PracticeSessionListItem:
      type: object
      required: [sessionId, status, createdAt, lastActivityAt, isTimed, targetCount, correctCount]
      properties:
        sessionId:
          type: string
        status:
          type: string
          enum: [active, paused, finished]
        createdAt:
          type: string
          description: RFC3339 timestamp
        lastActivityAt:
          type: string
          description: RFC3339 timestamp
        packageId:
          type: string
          nullable: true
        isTimed:
          type: boolean
        timeLimitSeconds:
          type: integer
          nullable: true
        timeRemainingSeconds:
          type: integer
          nullable: true
        targetCount:
          type: integer
        correctCount:
          type: integer
        accuracy:
          type: number
          format: float

    CreatePracticeSessionRequest:
      type: object
      required: [timed, count]
      properties:
        packageId:
          type: string
          nullable: true
        timed:
          type: boolean
        count:
          type: integer
          minimum: 1
          maximum: 50

    PracticeQuestionChoice:
      type: object
      required: [id, text]
      properties:
        id:
          type: string
        text:
          type: string

    PracticeQuestion:
      type: object
      required: [id, prompt, choices]
      properties:
        id:
          type: string
        prompt:
          type: string
        choices:
          type: array
          items:
            $ref: '#/components/schemas/PracticeQuestionChoice'

    PracticeSessionResponse:
      type: object
      required: [sessionId, status, createdAt, startedAt, isTimed, targetCount, currentIndex, total, correctCount]
      properties:
        sessionId:
          type: string
        status:
          type: string
          enum: [active, paused, finished]
        createdAt:
          type: string
          description: RFC3339 timestamp
        startedAt:
          type: string
          description: RFC3339 timestamp
        packageId:
          type: string
          nullable: true
        isTimed:
          type: boolean
        timeLimitSeconds:
          type: integer
          nullable: true
        currentQuestionStartedAt:
          type: string
          nullable: true
          description: RFC3339 timestamp
        questionTimingsSeconds:
          type: object
          nullable: true
          additionalProperties:
            type: integer
        targetCount:
          type: integer
        currentIndex:
          type: integer
        total:
          type: integer
        correctCount:
          type: integer
        question:
          nullable: true
          $ref: '#/components/schemas/PracticeQuestion'

    SubmitPracticeAnswerRequest:
      type: object
      required: [questionId, choiceId]
      properties:
        questionId:
          type: string
        choiceId:
          type: string
        ts:
          type: string
          nullable: true
          description: RFC3339 timestamp

    SubmitPracticeAnswerResponse:
      type: object
      required: [correct, explanation, done]
      properties:
        correct:
          type: boolean
        explanation:
          type: string
        done:
          type: boolean

    PracticeSessionSummaryResponse:
      type: object
      required: [sessionId, total, correctCount, accuracy]
      properties:
        sessionId:
          type: string
        total:
          type: integer
        correctCount:
          type: integer
        accuracy:
          type: number
          format: float

    RegisterRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
        password:
          type: string
          description: Plaintext password (sent over HTTPS in production)

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
        password:
          type: string

    User:
      type: object
      required: [id, email, role, createdAt]
      properties:
        id:
          type: string
        email:
          type: string
        role:
          type: string
          enum: [student, instructor, admin]
        createdAt:
          type: string
          description: RFC3339 timestamp

    AuthResponse:
      type: object
      required: [accessToken, user]
      properties:
        accessToken:
          type: string
        user:
          $ref: '#/components/schemas/User'
