openapi: 3.0.3
info:
  title: ACE API
  version: 0.1.0
servers:
  - url: http://localhost:8080
paths:
  /healthz:
    get:
      operationId: healthz
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthzResponse'

  /auth/register:
    post:
      deprecated: true
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '200':
          description: Registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /auth/login:
    post:
      deprecated: true
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /auth/me:
    get:
      deprecated: true
      operationId: me
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /student/auth/register:
    post:
      operationId: studentRegister
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '200':
          description: Registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /student/auth/login:
    post:
      operationId: studentLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /student/auth/me:
    get:
      operationId: studentMe
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /instructor/auth/login:
    post:
      operationId: instructorLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /instructor/auth/me:
    get:
      operationId: instructorMe
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /admin/auth/login:
    post:
      operationId: adminLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /admin/auth/me:
    get:
      operationId: adminMe
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /admin/users:
    get:
      operationId: adminListUsers
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: offset
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
        - in: query
          name: role
          required: false
          schema:
            type: string
            enum: [student, instructor, admin]
        - in: query
          name: includeDeleted
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListAdminUsersResponse'
    post:
      operationId: adminCreateUser
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAdminUserRequest'
      responses:
        '200':
          description: User created
          content:
            application/json:
              schema:
                type: object
                required: [id]
                properties:
                  id:
                    type: string

  /admin/users/{userId}:
    get:
      operationId: adminGetUser
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminUser'
    patch:
      operationId: adminUpdateUser
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAdminUserRequest'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'
    delete:
      operationId: adminDeleteUser
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Deleted (soft)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'

  /admin/users/{userId}/restore:
    post:
      operationId: adminRestoreUser
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Restored
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'

  /admin/exam-sessions:
    get:
      operationId: adminListExamSessions
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: offset
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
        - in: query
          name: status
          required: false
          schema:
            type: string
            enum: [active, finished, terminated, invalid]
      responses:
        '200':
          description: Exam sessions (admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListAdminExamSessionsResponse'

  /admin/exam-sessions/{userId}/{sessionId}:
    get:
      operationId: adminGetExamSession
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Exam session detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminExamSessionResponse'

  /admin/exam-sessions/{userId}/{sessionId}/force-submit:
    post:
      operationId: adminForceSubmitExamSession
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'

  /admin/exam-sessions/{userId}/{sessionId}/terminate:
    post:
      operationId: adminTerminateExamSession
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminExamActionRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'

  /admin/exam-sessions/{userId}/{sessionId}/invalidate:
    post:
      operationId: adminInvalidateExamSession
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminExamActionRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'

  /admin/exam-sessions/{userId}/{sessionId}/flags:
    post:
      operationId: adminCreateExamFlag
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminFlagRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'

  /admin/exam-sessions/{userId}/{sessionId}/events:
    get:
      operationId: adminListExamEvents
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: offset
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListAdminExamEventsResponse'

  /practice-sessions:
    get:
      operationId: listPracticeSessions
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: offset
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
        - in: query
          name: status
          required: false
          schema:
            type: string
            enum: [active, paused, finished]
      responses:
        '200':
          description: Practice sessions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListPracticeSessionsResponse'
    post:
      operationId: createPracticeSession
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePracticeSessionRequest'
      responses:
        '200':
          description: Practice session created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PracticeSessionResponse'

  /exam-sessions:
    get:
      operationId: listExamSessions
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: offset
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
        - in: query
          name: status
          required: false
          schema:
            type: string
            enum: [active, finished, terminated, invalid]
      responses:
        '200':
          description: Exam sessions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListExamSessionsResponse'

  /questions:
    get:
      operationId: listQuestions
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: offset
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
        - in: query
          name: packageId
          required: false
          schema:
            type: string
        - in: query
          name: topicId
          required: false
          schema:
            type: string
        - in: query
          name: difficultyId
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Published questions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListQuestionsResponse'

  /questions/{questionId}:
    get:
      operationId: getQuestion
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: questionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Published question
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicQuestionResponse'

  /question-packages:
    get:
      operationId: listQuestionPackages
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Question packages
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListQuestionPackagesResponse'

  /question-topics:
    get:
      operationId: listQuestionTopics
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: packageId
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Question topics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListQuestionTopicsResponse'

  /question-difficulties:
    get:
      operationId: listQuestionDifficulties
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Question difficulties
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListQuestionDifficultiesResponse'

  /instructor/question-packages:
    get:
      operationId: instructorListQuestionPackages
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Question packages
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListQuestionPackagesResponse'
    post:
      operationId: instructorCreateQuestionPackage
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateQuestionPackageRequest'
      responses:
        '200':
          description: Package created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateQuestionPackageResponse'

  /instructor/question-topics:
    get:
      operationId: instructorListQuestionTopics
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: packageId
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Question topics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListQuestionTopicsResponse'
    post:
      operationId: instructorCreateQuestionTopic
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateQuestionTopicRequest'
      responses:
        '200':
          description: Topic created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateQuestionTopicResponse'

  /instructor/questions:
    get:
      operationId: instructorListQuestions
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: offset
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
        - in: query
          name: status
          required: false
          schema:
            type: string
            enum: [draft, in_review, needs_changes, published, archived]
        - in: query
          name: packageId
          required: false
          schema:
            type: string
        - in: query
          name: topicId
          required: false
          schema:
            type: string
        - in: query
          name: difficultyId
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Question list (instructor/admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListQuestionsResponse'
    post:
      operationId: instructorCreateQuestion
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateQuestionRequest'
      responses:
        '200':
          description: Question created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InstructorQuestionResponse'

  /instructor/questions/{questionId}:
    get:
      operationId: instructorGetQuestion
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: questionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Question detail (instructor/admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InstructorQuestionResponse'
    put:
      operationId: instructorUpdateQuestion
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: questionId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateQuestionRequest'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'

  /instructor/questions/{questionId}/choices:
    put:
      operationId: instructorReplaceChoices
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: questionId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReplaceChoicesRequest'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'

  /instructor/questions/{questionId}/publish:
    post:
      operationId: instructorPublishQuestion
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: questionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'

  /instructor/questions/{questionId}/archive:
    post:
      operationId: instructorArchiveQuestion
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: questionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'

  /instructor/questions/{questionId}/draft:
    post:
      operationId: instructorDraftQuestion
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: questionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'

  /instructor/questions/{questionId}/submit-for-review:
    post:
      operationId: instructorSubmitQuestionForReview
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: questionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'

  /admin/questions/{questionId}/approve:
    post:
      operationId: adminApproveQuestion
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: questionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Approved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'

  /admin/questions/{questionId}/request-changes:
    post:
      operationId: adminRequestQuestionChanges
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: questionId
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                note:
                  type: string
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'

  /exam-sessions/{sessionId}/heartbeat:
    post:
      operationId: heartbeat
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HeartbeatRequest'
      responses:
        '200':
          description: Heartbeat accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HeartbeatResponse'

  /exam-sessions/{sessionId}:
    get:
      operationId: getExamSession
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Exam session state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExamSessionResponse'

  /exam-sessions/{sessionId}/submit:
    post:
      operationId: submitExamSession
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Exam session submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExamSessionResponse'

  /exam-sessions/{sessionId}/events:
    post:
      operationId: recordExamEvent
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExamEventRequest'
      responses:
        '200':
          description: Recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'

  /practice-sessions/{sessionId}:
    get:
      operationId: getPracticeSession
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Practice session state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PracticeSessionResponse'

  /practice-sessions/{sessionId}/pause:
    post:
      operationId: pausePracticeSession
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Practice session paused
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PracticeSessionResponse'

  /practice-sessions/{sessionId}/resume:
    post:
      operationId: resumePracticeSession
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Practice session resumed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PracticeSessionResponse'

  /practice-sessions/{sessionId}/answers:
    post:
      operationId: submitPracticeAnswer
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitPracticeAnswerRequest'
      responses:
        '200':
          description: Answer accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmitPracticeAnswerResponse'

  /practice-sessions/{sessionId}/summary:
    get:
      operationId: getPracticeSessionSummary
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Practice summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PracticeSessionSummaryResponse'

  /practice-sessions/{sessionId}/review:
    get:
      operationId: getPracticeSessionReview
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Ordered review breakdown (finished sessions only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PracticeSessionReviewResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    HealthzResponse:
      type: object
      required: [status, ts]
      properties:
        status:
          type: string
        ts:
          type: string
          description: RFC3339 timestamp

    HeartbeatRequest:
      type: object
      required: [sessionId, ts, snapshot]
      properties:
        sessionId:
          type: string
        ts:
          type: string
          description: RFC3339 timestamp
        snapshot:
          description: Latest client-side snapshot for recovery
          type: object
          additionalProperties: true
          nullable: true

    HeartbeatResponse:
      type: object
      required: [ok, serverTs]
      properties:
        ok:
          type: boolean
        serverTs:
          type: string
          description: RFC3339 timestamp

    ExamSessionResponse:
      type: object
      required: [sessionId, status, createdAt, updatedAt, lastHeartbeatAt, snapshot]
      properties:
        sessionId:
          type: string
        status:
          type: string
          enum: [active, finished, terminated, invalid]
        submittedAt:
          type: string
          nullable: true
          description: RFC3339 timestamp
        createdAt:
          type: string
          description: RFC3339 timestamp
        updatedAt:
          type: string
          description: RFC3339 timestamp
        lastHeartbeatAt:
          type: string
          description: RFC3339 timestamp
        snapshot:
          type: object
          additionalProperties: true

    ListExamSessionsResponse:
      type: object
      required: [items, limit, offset, hasMore]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ExamSessionListItem'
        limit:
          type: integer
        offset:
          type: integer
        hasMore:
          type: boolean

    ExamSessionListItem:
      type: object
      required: [sessionId, status, createdAt, updatedAt, lastHeartbeatAt]
      properties:
        sessionId:
          type: string
        status:
          type: string
          enum: [active, finished, terminated, invalid]
        submittedAt:
          type: string
          nullable: true
          description: RFC3339 timestamp
        createdAt:
          type: string
          description: RFC3339 timestamp
        updatedAt:
          type: string
          description: RFC3339 timestamp
        lastHeartbeatAt:
          type: string
          description: RFC3339 timestamp

    ListPracticeSessionsResponse:
      type: object
      required: [items, limit, offset, hasMore]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/PracticeSessionListItem'
        limit:
          type: integer
        offset:
          type: integer
        hasMore:
          type: boolean

    PracticeSessionListItem:
      type: object
      required: [sessionId, status, createdAt, lastActivityAt, isTimed, targetCount, correctCount]
      properties:
        sessionId:
          type: string
        status:
          type: string
          enum: [active, paused, finished]
        createdAt:
          type: string
          description: RFC3339 timestamp
        lastActivityAt:
          type: string
          description: RFC3339 timestamp
        packageId:
          type: string
          nullable: true
        isTimed:
          type: boolean
        timeLimitSeconds:
          type: integer
          nullable: true
        timeRemainingSeconds:
          type: integer
          nullable: true
        targetCount:
          type: integer
        correctCount:
          type: integer
        accuracy:
          type: number
          format: float

    CreatePracticeSessionRequest:
      type: object
      required: [timed, count]
      properties:
        packageId:
          type: string
          nullable: true
        timed:
          type: boolean
        count:
          type: integer
          minimum: 1
          maximum: 50

    PracticeQuestionChoice:
      type: object
      required: [id, text]
      properties:
        id:
          type: string
        text:
          type: string

    PracticeQuestion:
      type: object
      required: [id, prompt, choices]
      properties:
        id:
          type: string
        prompt:
          type: string
        choices:
          type: array
          items:
            $ref: '#/components/schemas/PracticeQuestionChoice'

    PracticeSessionResponse:
      type: object
      required: [sessionId, status, createdAt, startedAt, isTimed, targetCount, currentIndex, total, correctCount]
      properties:
        sessionId:
          type: string
        status:
          type: string
          enum: [active, paused, finished]
        createdAt:
          type: string
          description: RFC3339 timestamp
        startedAt:
          type: string
          description: RFC3339 timestamp
        packageId:
          type: string
          nullable: true
        isTimed:
          type: boolean
        timeLimitSeconds:
          type: integer
          nullable: true
        currentQuestionStartedAt:
          type: string
          nullable: true
          description: RFC3339 timestamp
        questionTimingsSeconds:
          type: object
          nullable: true
          additionalProperties:
            type: integer
        targetCount:
          type: integer
        currentIndex:
          type: integer
        total:
          type: integer
        correctCount:
          type: integer
        question:
          nullable: true
          $ref: '#/components/schemas/PracticeQuestion'

    SubmitPracticeAnswerRequest:
      type: object
      required: [questionId, choiceId]
      properties:
        questionId:
          type: string
        choiceId:
          type: string
        ts:
          type: string
          nullable: true
          description: RFC3339 timestamp

    SubmitPracticeAnswerResponse:
      type: object
      required: [correct, explanation, done]
      properties:
        correct:
          type: boolean
        explanation:
          type: string
        done:
          type: boolean

    PracticeSessionSummaryResponse:
      type: object
      required: [sessionId, total, correctCount, accuracy]
      properties:
        sessionId:
          type: string
        total:
          type: integer
        correctCount:
          type: integer
        accuracy:
          type: number
          format: float

    PracticeSessionReviewResponse:
      type: object
      required: [sessionId, items]
      properties:
        sessionId:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/PracticeSessionReviewItem'

    PracticeSessionReviewItem:
      type: object
      required: [index, question, timeTakenSeconds, correctChoiceId]
      properties:
        index:
          type: integer
        question:
          $ref: '#/components/schemas/PracticeQuestion'
        selectedChoiceId:
          type: string
          nullable: true
        correct:
          type: boolean
          nullable: true
        explanation:
          type: string
          nullable: true
        timeTakenSeconds:
          type: integer
        correctChoiceId:
          type: string

    RegisterRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
        password:
          type: string
          description: Plaintext password (sent over HTTPS in production)

    OkResponse:
      type: object
      required: [ok]
      properties:
        ok:
          type: boolean

    QuestionDifficulty:
      type: object
      required: [id, displayName]
      properties:
        id:
          type: string
        displayName:
          type: string

    ListQuestionDifficultiesResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/QuestionDifficulty'

    QuestionPackage:
      type: object
      required: [id, name, createdAt]
      properties:
        id:
          type: string
        name:
          type: string
        createdAt:
          type: string
          description: RFC3339 timestamp

    QuestionTopic:
      type: object
      required: [id, name, createdAt]
      properties:
        id:
          type: string
        packageId:
          type: string
          nullable: true
        name:
          type: string
        createdAt:
          type: string
          description: RFC3339 timestamp

    ListQuestionPackagesResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/QuestionPackage'

    ListQuestionTopicsResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/QuestionTopic'

    PublicQuestionListItem:
      type: object
      required: [id, difficultyId, prompt]
      properties:
        id:
          type: string
        packageId:
          type: string
          nullable: true
        topicId:
          type: string
          nullable: true
        difficultyId:
          type: string
        prompt:
          type: string

    ListQuestionsResponse:
      type: object
      required: [items, limit, offset, hasMore]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/PublicQuestionListItem'
        limit:
          type: integer
        offset:
          type: integer
        hasMore:
          type: boolean

    PublicQuestionResponse:
      type: object
      required: [id, difficultyId, prompt, choices]
      properties:
        id:
          type: string
        packageId:
          type: string
          nullable: true
        topicId:
          type: string
          nullable: true
        difficultyId:
          type: string
        prompt:
          type: string
        choices:
          type: array
          items:
            $ref: '#/components/schemas/PracticeQuestionChoice'

    CreateQuestionPackageRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string

    CreateQuestionPackageResponse:
      type: object
      required: [id]
      properties:
        id:
          type: string

    CreateQuestionTopicRequest:
      type: object
      required: [name]
      properties:
        packageId:
          type: string
          nullable: true
        name:
          type: string

    CreateQuestionTopicResponse:
      type: object
      required: [id]
      properties:
        id:
          type: string

    CreateQuestionRequest:
      type: object
      required: [difficultyId, prompt, explanation, choices, correctChoiceIndex]
      properties:
        packageId:
          type: string
          nullable: true
        topicId:
          type: string
          nullable: true
        difficultyId:
          type: string
        prompt:
          type: string
        explanation:
          type: string
        choices:
          type: array
          minItems: 2
          items:
            type: object
            required: [text]
            properties:
              text:
                type: string
        correctChoiceIndex:
          type: integer
          minimum: 0

    UpdateQuestionRequest:
      type: object
      properties:
        packageId:
          type: string
          nullable: true
        topicId:
          type: string
          nullable: true
        difficultyId:
          type: string
          nullable: true
        prompt:
          type: string
          nullable: true
        explanation:
          type: string
          nullable: true

    ReplaceChoicesRequest:
      type: object
      required: [choices, correctChoiceIndex]
      properties:
        choices:
          type: array
          minItems: 2
          items:
            type: object
            required: [text]
            properties:
              text:
                type: string
        correctChoiceIndex:
          type: integer
          minimum: 0

    InstructorQuestionResponse:
      type: object
      required:
        - id
        - difficultyId
        - prompt
        - explanation
        - status
        - correctChoiceId
        - choices
        - createdByUserId
        - updatedByUserId
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
        packageId:
          type: string
          nullable: true
        topicId:
          type: string
          nullable: true
        difficultyId:
          type: string
        prompt:
          type: string
        explanation:
          type: string
        status:
          type: string
          enum: [draft, in_review, needs_changes, published, archived]
        correctChoiceId:
          type: string
        choices:
          type: array
          items:
            $ref: '#/components/schemas/PracticeQuestionChoice'
        createdByUserId:
          type: string
        updatedByUserId:
          type: string
        createdAt:
          type: string
          description: RFC3339 timestamp
        updatedAt:
          type: string
          description: RFC3339 timestamp

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
        password:
          type: string

    User:
      type: object
      required: [id, email, role, createdAt]
      properties:
        id:
          type: string
        email:
          type: string
        role:
          type: string
          enum: [student, instructor, admin]
        createdAt:
          type: string
          description: RFC3339 timestamp

    ExamEventRequest:
      type: object
      required: [eventType]
      properties:
        eventType:
          type: string
        ts:
          type: string
          nullable: true
          description: RFC3339 timestamp
        payload:
          type: object
          nullable: true
          additionalProperties: true

    AdminUser:
      type: object
      required: [id, email, role, createdAt, updatedAt]
      properties:
        id:
          type: string
        email:
          type: string
        role:
          type: string
          enum: [student, instructor, admin]
        createdAt:
          type: string
          description: RFC3339 timestamp
        updatedAt:
          type: string
          description: RFC3339 timestamp
        deletedAt:
          type: string
          nullable: true
          description: RFC3339 timestamp

    AdminUserListItem:
      allOf:
        - $ref: '#/components/schemas/AdminUser'

    ListAdminUsersResponse:
      type: object
      required: [items, limit, offset, hasMore]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/AdminUserListItem'
        limit:
          type: integer
        offset:
          type: integer
        hasMore:
          type: boolean

    CreateAdminUserRequest:
      type: object
      required: [email, password, role]
      properties:
        email:
          type: string
        password:
          type: string
        role:
          type: string
          enum: [student, instructor, admin]

    UpdateAdminUserRequest:
      type: object
      properties:
        email:
          type: string
          nullable: true
        password:
          type: string
          nullable: true
        role:
          type: string
          nullable: true
          enum: [student, instructor, admin]

    AdminExamSessionListItem:
      type: object
      required: [userId, userEmail, sessionId, status, createdAt, updatedAt, lastHeartbeatAt]
      properties:
        userId:
          type: string
        userEmail:
          type: string
        sessionId:
          type: string
        status:
          type: string
          enum: [active, finished, terminated, invalid]
        createdAt:
          type: string
          description: RFC3339 timestamp
        updatedAt:
          type: string
          description: RFC3339 timestamp
        lastHeartbeatAt:
          type: string
          description: RFC3339 timestamp
        submittedAt:
          type: string
          nullable: true
          description: RFC3339 timestamp
        terminatedAt:
          type: string
          nullable: true
          description: RFC3339 timestamp
        invalidatedAt:
          type: string
          nullable: true
          description: RFC3339 timestamp

    ListAdminExamSessionsResponse:
      type: object
      required: [items, limit, offset, hasMore]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/AdminExamSessionListItem'
        limit:
          type: integer
        offset:
          type: integer
        hasMore:
          type: boolean

    AdminExamSessionResponse:
      type: object
      required: [userId, userEmail, sessionId, status, createdAt, updatedAt, lastHeartbeatAt, snapshot, terminationReason, invalidationReason]
      properties:
        userId:
          type: string
        userEmail:
          type: string
        sessionId:
          type: string
        status:
          type: string
          enum: [active, finished, terminated, invalid]
        createdAt:
          type: string
          description: RFC3339 timestamp
        updatedAt:
          type: string
          description: RFC3339 timestamp
        lastHeartbeatAt:
          type: string
          description: RFC3339 timestamp
        submittedAt:
          type: string
          nullable: true
          description: RFC3339 timestamp
        terminatedAt:
          type: string
          nullable: true
          description: RFC3339 timestamp
        terminatedByUserId:
          type: string
          nullable: true
        terminationReason:
          type: string
        invalidatedAt:
          type: string
          nullable: true
          description: RFC3339 timestamp
        invalidatedByUserId:
          type: string
          nullable: true
        invalidationReason:
          type: string
        snapshot:
          type: object
          additionalProperties: true

    AdminExamActionRequest:
      type: object
      properties:
        reason:
          type: string

    AdminFlagRequest:
      type: object
      required: [flagType]
      properties:
        flagType:
          type: string
        note:
          type: string

    AdminExamEventListItem:
      type: object
      required: [id, eventType, payload, createdAt]
      properties:
        id:
          type: integer
        eventType:
          type: string
        payload:
          type: object
          additionalProperties: true
        createdAt:
          type: string
          description: RFC3339 timestamp

    ListAdminExamEventsResponse:
      type: object
      required: [items, limit, offset, hasMore]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/AdminExamEventListItem'
        limit:
          type: integer
        offset:
          type: integer
        hasMore:
          type: boolean

    AuthResponse:
      type: object
      required: [accessToken, user]
      properties:
        accessToken:
          type: string
        user:
          $ref: '#/components/schemas/User'
